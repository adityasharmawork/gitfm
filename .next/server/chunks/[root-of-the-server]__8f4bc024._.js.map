{"version":3,"sources":["../../../lib/session.ts"],"sourcesContent":["import crypto from \"crypto\"\n\n// Use a secret key from environment variable (must be 32 bytes for AES-256)\nconst getSecretKey = (): Buffer => {\n    const secret = process.env.SESSION_SECRET\n    if (!secret) {\n        throw new Error(\"SESSION_SECRET environment variable is required\")\n    }\n    // Create a consistent 32-byte key from the secret\n    return crypto.createHash(\"sha256\").update(secret).digest()\n}\n\nconst ALGORITHM = \"aes-256-gcm\"\nconst IV_LENGTH = 16\nconst AUTH_TAG_LENGTH = 16\n\nexport function encryptSession(data: object): string {\n    const key = getSecretKey()\n    const iv = crypto.randomBytes(IV_LENGTH)\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv)\n\n    const jsonData = JSON.stringify(data)\n    const encrypted = Buffer.concat([cipher.update(jsonData, \"utf8\"), cipher.final()])\n    const authTag = cipher.getAuthTag()\n\n    // Combine IV + AuthTag + Encrypted data, then base64 encode\n    const combined = Buffer.concat([iv, authTag, encrypted])\n    return combined.toString(\"base64\")\n}\n\nexport function decryptSession<T = unknown>(encryptedData: string): T | null {\n    try {\n        const key = getSecretKey()\n        const combined = Buffer.from(encryptedData, \"base64\")\n\n        // Extract IV, AuthTag, and encrypted data\n        const iv = combined.subarray(0, IV_LENGTH)\n        const authTag = combined.subarray(IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH)\n        const encrypted = combined.subarray(IV_LENGTH + AUTH_TAG_LENGTH)\n\n        const decipher = crypto.createDecipheriv(ALGORITHM, key, iv)\n        decipher.setAuthTag(authTag)\n\n        const decrypted = Buffer.concat([decipher.update(encrypted), decipher.final()])\n        return JSON.parse(decrypted.toString(\"utf8\")) as T\n    } catch (error) {\n        console.error(\"Session decryption failed:\", error)\n        return null\n    }\n}\n"],"names":[],"mappings":"kjCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAGA,IAAM,EAAe,KACjB,IAAM,EAAS,QAAQ,GAAG,CAAC,cAAc,CACzC,GAAI,CAAC,EACD,MADS,AACH,AAAI,MAAM,mDAGpB,OAAO,EAAA,OAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,GAAQ,MAAM,EAC5D,EAEM,EAAY,cAIX,SAAS,EAAe,CAAY,EACvC,IAAM,EAAM,IACN,EAAK,EAAA,OAAM,CAAC,WAAW,CAAC,IACxB,EAAS,EAAA,OAAM,CAAC,cAAc,CAAC,EAAW,EAAK,GAE/C,EAAW,KAAK,SAAS,CAAC,GAC1B,EAAY,OAAO,MAAM,CAAC,CAAC,EAAO,MAAM,CAAC,EAAU,QAAS,EAAO,KAAK,GAAG,EAC3E,EAAU,EAAO,UAAU,GAIjC,OADiB,AACV,OADiB,MAAM,CAAC,CAAC,EAAI,EAAS,EAAU,EACvC,QAAQ,CAAC,SAC7B,CAEO,SAAS,EAA4B,CAAqB,EAC7D,GAAI,CACA,IAAM,EAAM,IACN,EAAW,OAAO,IAAI,CAAC,EAAe,UAGtC,EAAK,EAAS,QAAQ,CAAC,GAAG,GAC1B,EAAU,EAAS,QAAQ,CAAC,AAxBxB,GAwBmC,IACvC,EAAY,EAAS,IAD8B,IACtB,CAAC,IAE9B,EAAW,EAAA,IAF+B,GAEzB,CAAC,gBAAgB,CAAC,EAAW,EAAK,GACzD,EAAS,UAAU,CAAC,GAEpB,IAAM,EAAY,OAAO,MAAM,CAAC,CAAC,EAAS,MAAM,CAAC,GAAY,EAAS,KAAK,GAAG,EAC9E,OAAO,KAAK,KAAK,CAAC,EAAU,QAAQ,CAAC,QACzC,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,6BAA8B,GACrC,IACX,CACJ"}